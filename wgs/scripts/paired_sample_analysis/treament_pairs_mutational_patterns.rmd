---
title: "Mutational Signatures Paired Analysis"
author: "Aidan Flynn"
date: "2023-02-06"
output: html_document
---

```{r setup, include = FALSE}
base_dir <- "/g/data/pq08/projects/ppgl/a5/wgs"

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
knitr::opts_knit$set(root.dir = base_dir)

```

This code performs paired analysis of pre/post-treatment and primary/metastasis pairings to observe the evolution of genomic signatures    

The analysis relies on data previously generated by:
"/g/data/pq08/projects/ppgl/a5/wgs/analysis/mutational_patterns/A5_mutational_patterns.r"

```{r data_loading, include=FALSE}
base_dir <- "/g/data/pq08/projects/ppgl/a5/wgs"

load("/g/data/pq08/projects/ppgl/a5/wgs/analysis/mutational_patterns/A5_mutational_patterns.rworkspace")
names(vcf_files) <- stringr::str_extract(basename(vcf_files), pattern = "E...-.")


library(MutationalPatterns)
library(BSgenome.Hsapiens.UCSC.hg38)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggrepel)
library(patchwork)


source(paste0(base_dir, "/scripts/utility/compare_vcf_calls.r"))
source(paste0(base_dir, "/../sample_annotation/scripts/data_loaders/a5_clinical_annotation_dataloader.r"))
data_loader_a5_clinical_anno(google_account = "aidan.flynn@umccr-radio-lab.page", use_cache = T)


blacklist="./analysis/mpileup/blacklists/blacklist_readsupport_gteq3_samplesupport_gteq3.tsv"
blacklisted_variants <- read.delim(blacklist)

treatment_related_sigs<-c("SBS11", "SBS25", "SBS31", 
                          "SBS32", "SBS35", "SBS86", 
                          "SBS87")

```

```{r patient_groups, include=FALSE}

##################
# Patient groups #
##################

#Pri/Met pairs
pri_met_paired <- a5_anno %>% group_by(`Patient ID`) %>% 
  filter(any(is_primary_or_met=="Primary") & 
           any(is_primary_or_met=="Metastasis")) %>% pull(`Patient ID`) %>% unique()

#Treated/untreated samples
treated_patients <- a5_anno %>% group_by(`Patient ID`) %>% 
  filter(any(grepl("Yes", Resection_post_dna_damaging_treatment)))

paired_treated_untreated <- treated_patients %>% 
  filter(sum(grepl("Yes", Resection_post_dna_damaging_treatment)) < n()) %>% 
  pull(`Patient ID`) %>% unique()
paired_treated_untreated <- c(paired_treated_untreated, "E167")

only_treated <- treated_patients %>% 
  filter(all(grepl("Yes", Resection_post_dna_damaging_treatment))) %>% 
  pull(`Patient ID`) %>% unique()

untreated_samples <- a5_anno %>%  
  filter(is.na(Resection_post_dna_damaging_treatment) | 
           Resection_post_dna_damaging_treatment == "No") %>% 
  pull(A5_ID)


treatment_state <- a5_anno %>% filter(Exclude=='N') %>% 
  dplyr::select(A5_ID, `Patient ID`, PublicationID, Resection_post_dna_damaging_treatment) %>% 
  mutate(treatment_state = gsub("Yes", "Treated", Resection_post_dna_damaging_treatment),
         treatment_state = gsub("No", "Untreated", treatment_state),
         treatment_state = ifelse(is.na(treatment_state), "Unknown", treatment_state)) %>% 
  dplyr::select(-Resection_post_dna_damaging_treatment)

```

```{r subtraction_analysis, include=FALSE}
###############
# Subtraction Analysis
###############

Samples <- a5_anno %>% 
  filter(`Patient ID` %in% c(paired_treated_untreated, pri_met_paired)) %>% 
  dplyr::select(`Patient ID`, A5_ID) %>% split(.,.$`Patient ID`) %>% 
  purrr::map(.f = ~pull(.x,A5_ID))

if (!file.exists("./quickload_checkpoints/treated_samples_vcf_as_granges.rds")) { 

#Pairwise matching of VCFs - returns a list of dataframes with variant calls marked present/absent for each sample from each patient
matched_variant_tables <- list()
for (patient in names(Samples))
{
  vcf_paths <- vcf_files[Samples[[patient]]]

  matched_variant_tables[[patient]] <-
    multi_compare_small_variant_vcf(
      vcfs = vcf_paths,
      normal_names = gsub("-.+", "-B01", Samples[[patient]]),
      tumour_names = gsub("-", "-T0", Samples[[patient]]),
      genome = "BSgenome.Hsapiens.UCSC.hg38",
      #Keep_Only_Highest_Consequence = T,
      #collapse_annotation = T
      drop_info = T)
  
}
saveRDS(matched_variant_tables, "./quickload_checkpoints/treated_samples_matched_variants.rds")
} else {
  matched_variant_tables <- readRDS("./quickload_checkpoints/treated_samples_matched_variants.rds")
}

#Fix and samples names that have dashes replaced with dots
  matched_variant_tables <-
    lapply(matched_variant_tables, function (table) {
      return(rename_with(
        table,
        .fn = ~ gsub("(E[0-9]{3}).([TB][0-9]{2})", "\\1-\\2", .x),
        .cols = matches("_Called$|_VAF$")
      ))
    })
  
  
#Annotate black listed variants
  
matched_variant_tables <-
  lapply(matched_variant_tables, function (table, black_list = blacklisted_variants) {
    table <- table %>% 
      left_join(black_list %>% 
                  dplyr::rename("blacklist_n_normal_observed"=n_above_threshold) %>% 
                  mutate(blacklist=TRUE),
                by = c("seqnames", "start", "end", "ALT"))
    
    table$blacklist_n_normal_observed[is.na(table$blacklist_n_normal_observed)] <- 0
    table$blacklist[is.na(table$blacklist)] <- F
    return(table %>% filter(blacklist==F))
  })

# Matched primary/met

met_only_variants <- list(
  E143=(matched_variant_tables$E143 %>% 
          filter(`E143-T03_Called` == "N" & #Primary
                   `E143-T01_Called` == "Y" | #Met 
                   `E143-T02_Called` == "Y")), #Met
  E146=(matched_variant_tables$E146 %>% 
          filter(`E146-T01_Called` == "N" & #Primary
                   `E146-T02_Called` == "Y")), #Met
  E159=(matched_variant_tables$E159 %>% 
          filter(`E159-T03_Called` == "N" & #Primary
                   `E159-T02_Called` == "N" & #Unrelated Primary
            `E159-T01_Called` == "Y" & #Met 
                   `E159-T04_Called` == "Y")), #Met
  E225=(matched_variant_tables$E225 %>% 
          filter(`E225-T01_Called` == "N" & #Primary 
                   `E225-T02_Called` == "Y"))) #Met

# Matched Treated

treated_only_variants <- list(
  E132=(matched_variant_tables$E132 %>% 
          filter(`E132-T02_Called` == "Y" & #Treated
                   `E132-T01_Called` == "N")), #Untreated
  E143=(matched_variant_tables$E143 %>% 
          filter(`E143-T02_Called` == "Y" & #Treated
                   `E143-T01_Called` == "N" & #Untreated 
                   `E143-T03_Called` == "N")), #Untreated
  E169=(matched_variant_tables$E169 %>% 
          filter(`E169-T02_Called` == "Y" & #Treated 
                   `E169-T01_Called` == "N")), #Untreated
  E167=(matched_variant_tables$E167 %>% 
          filter(`E167-T01_Called` == "Y" & #Treated 
                   `E167-T02_Called` == "N"))) #Untreated


met_only_variants_gr <- lapply(met_only_variants, function(df){
  primary_contigs <- paste0("chr", c(1:22, "X", "Y"))
  
  df <- df %>% 
    ungroup() %>% 
    dplyr::select("seqnames", "start", "end", "width", "strand", "REF", "ALT") %>% 
    mutate(QUAL=100, FILTER="PASS") %>% 
    filter(seqnames %in% primary_contigs) %>% 
    mutate(seqnames = as.character(seqnames))
  
  
  gr <- GenomicRanges::makeGRangesFromDataFrame(df, keep.extra.columns = T)
  genome(gr) <- "hg38"
  return(gr)
})

treated_only_variants_gr <- lapply(treated_only_variants, function(df){
  primary_contigs <- paste0("chr", c(1:22, "X", "Y"))
  
  df <- df %>% 
    ungroup() %>% 
    dplyr::select("seqnames", "start", "end", "width", "strand", "REF", "ALT") %>% 
    mutate(QUAL=100, FILTER="PASS") %>% 
    filter(seqnames %in% primary_contigs) %>% 
    mutate(seqnames = as.character(seqnames))
  
  
  gr <- GenomicRanges::makeGRangesFromDataFrame(df, keep.extra.columns = T)
  genome(gr) <- "hg38"
  return(gr)
  })

met_snvs <- get_mut_type(met_only_variants_gr, type = "snv")
treated_snvs <- get_mut_type(treated_only_variants_gr, type = "snv")

mut_mat_met_exclusive <- mut_matrix(vcf_list = met_snvs, ref_genome = ref_genome)
mut_mat_treatment_exclusive <- mut_matrix(vcf_list = treated_snvs, ref_genome = ref_genome)

fit_res_met_exclusive <- fit_to_signatures(mut_mat_met_exclusive, signatures)
fit_res_treatment_exclusive <- fit_to_signatures(mut_mat_treatment_exclusive, signatures)
```

# Plots

```{r plot_data, include=FALSE}
############
# Plotting #
############

######
# Plot data
######


#All sample signatures - pivot to long form
plot_data_all <- 
  data.frame(fit_res$contribution, 
             check.names = F) %>% 
  tibble::rownames_to_column("Signature") %>% 
  tidyr::pivot_longer(cols = -Signature, 
                      names_to = "Sample",
                      values_to = "Contribution") %>% 
  mutate(`Patient ID`=gsub("-.","",Sample)) 
plot_data_all$Signature=factor(plot_data_all$Signature, 
                               levels = colnames(signatures))  

#join annotation
plot_data_all <- plot_data_all %>% 
  inner_join(a5_anno %>% filter(Exclude=="N") %>% dplyr::select(A5_ID, PublicationID, differential_group), by = c("Sample"="A5_ID")) %>% 
  left_join(treatment_state) %>% 
  mutate(treatment_state=replace_na(treatment_state, "Untreated"),
         treatment_state_simple=gsub(" ?[(].+$", "", 
                                            treatment_state),
         sample_type=gsub("(.+)_.+_.+_.+",
                          "\\1",
                          differential_group),
         sample_geno_type=gsub("(.+_.+)_.+_.+",
                               "\\1",
                               differential_group))
#label outliers
plot_data_all <- plot_data_all %>% 
  group_by(Signature) %>% mutate(label=ifelse(
    Contribution > (quantile(Contribution)[["75%"]] + (1.5*IQR(Contribution))),
    A5_ID,
    NA))


plot_data_met_exclusive <- data.frame(fit_res_met_exclusive$contribution, 
                                            check.names = F) %>% 
  tibble::rownames_to_column("Signature") %>% 
  tidyr::pivot_longer(cols = -Signature, 
                      names_to = "Sample",
                      values_to = "Contribution") %>% 
  mutate(`Patient ID`=gsub("-.","",Sample))
plot_data_met_exclusive$Signature=factor(plot_data_met_exclusive$Signature, levels = colnames(signatures))  

plot_data_treatment_exclusive <- 
  data.frame(fit_res_treatment_exclusive$contribution, 
             check.names = F) %>% 
  tibble::rownames_to_column("Signature") %>% 
  tidyr::pivot_longer(cols = -Signature, 
                      names_to = "Sample",
                      values_to = "Contribution") %>% 
  mutate(`Patient ID`=gsub("-.",
                           "",
                           Sample))
plot_data_treatment_exclusive$Signature=factor(plot_data_treatment_exclusive$Signature, 
                                               levels = colnames(signatures))  

plot_data_pri_met_combined <- bind_rows(plot_data_all,
                                        plot_data_met_exclusive %>% 
                                          mutate(PublicationID = `Patient ID`,
                                                 sample_type="Met only var.") ) %>% 
  arrange(`Patient ID`, sample_type) %>% 
  mutate(label=paste(PublicationID,sample_type)) %>% 
  mutate(label=factor(label, levels=unique(.$label))) 

plot_data_treated_untreated_combined <- bind_rows(plot_data_all,
                                plot_data_treatment_exclusive %>% 
                                  mutate(PublicationID = `Patient ID`,
                                         treatment_state="Post-treat. var. only",
                                         treatment_state_simple=treatment_state) ) %>% 
  arrange(`Patient ID`, treatment_state) %>% 
  mutate(label=paste(PublicationID,treatment_state)) %>% 
  mutate(label=factor(label, levels=unique(.$label))) 
```

## Heatmap of signature analysis from pre/post treatment samples

The top rows show signature contributions from the pre/post sample variants, while the bottom row shows the signature analysis for variants found only post treatment. 

```{r plots_heatmap_treatment, fig.height=12, fig.width=10}
######
# Plots
######

#heat map - treatment pairs
heat_tile_plot <- function (Patient) { plot_data_treated_untreated_combined %>% 
    filter(`Patient ID`==Patient) %>% 
    ggplot(mapping = aes(x=Signature, y=label, fill=Contribution)) + 
  geom_tile() +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust=1,vjust=0.5), axis.title.y = element_blank()) + 
  facet_wrap("`Patient ID`", scales="free", ncol=1) +
  scale_fill_gradientn(colors = c("white","blue","green","orange","red")) 
  }

heat_tile_plots_treatment <- purrr::map(paired_treated_untreated, heat_tile_plot)
Reduce("+", heat_tile_plots_treatment) + plot_layout(ncol=1) + plot_annotation(title="Variant subtraction signature analysis")
```
```{r categorical_scatter_plot_function}
#categorical scatter plot - base plotting function
gg_contrib_by_category  <- function (data, category_variable, color_variable) {
  ggplot(data, aes(x=!!sym(category_variable), y=Contribution, color=!!sym(color_variable))) + 
  geom_point(position = position_jitter(seed=100, width = 0.2)) +
  geom_path(mapping=aes(group=`Patient ID`), 
            position = position_jitter(seed=100, width = 0.2),
            alpha=0.3) + 
  geom_text_repel(aes(label=label), size=3) + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust=1,vjust=0.5)) + 
  facet_wrap("Signature", scales="free_y", ncol=4) }
```

## Treatment and disease state vs signature contribution

These categorical scatter plots show the contribution of each signature (y-axis) to each sample. Samples are segregated by treatment state or disease state (x-axis).  Samples that form part of a before and after treatment pair are indicated in color and samples from the sample patient are joined by a line.

```{r }
#categorical scatter plot - treatment by contribution
plot.temp <-  plot_data_treated_untreated_combined %>% 
  filter(`Patient ID`!="E167") %>% 
  group_by(Signature) %>% 
  filter(any(Contribution > 100)) %>%   
  group_by(Signature) %>% mutate(label=ifelse(
    Contribution > (quantile(Contribution)[["75%"]] + (1.5*IQR(Contribution))),
    A5_ID,
    NA)) %>% 
  mutate(color=ifelse(`Patient ID` %in% paired_treated_untreated, 
                      `Patient ID`, 
                      NA)) %>% 
  mutate(treatment_state_simple=factor(treatment_state_simple, 
                                       levels=c("Unknown", "Untreated", 
                                                "Possibly", "Treated", "Post-treat. var. only")))
```

## Per signature contribution {.tabset}

### Treatment state - All Samples
```{r plot_treatment_vs_contrib, fig.width=10, fig.height=20 }
gg_contrib_by_category(plot.temp, "treatment_state_simple", "color") +
  ggtitle("Treatment status vs contribution - All samples")
```

### Treatment state - Treat sigs only

```{r plot_treatment_vs_contrib_therapy, fig.width=10, fig.height=8 }
gg_contrib_by_category(plot.temp %>% 
                         filter(Signature %in% treatment_related_sigs), 
                       "treatment_state_simple", "color") +
  ggtitle("Treatment status vs contribution - All samples - therapy related sigs")

ggplot(plot_data_all %>%  filter(Signature %in% treatment_related_sigs),
       aes(x=A5_ID, y=Contribution, fill=treatment_state)) + 
  geom_col() + 
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  facet_wrap("Signature", scales = "free_y", ncol=1) 
```

### Treatment state - Paired Samples Only

```{r plot_treatment_vs_contrib_restricted, fig.width=10, fig.height=20}
gg_contrib_by_category(plot.temp %>% 
                         filter(`Patient ID` %in% paired_treated_untreated) %>% 
                         group_by(Signature) %>% 
                         filter(any(Contribution > 100)), 
                       "treatment_state_simple", "color") + 
  ggtitle("Treatment status vs contribution - Treated/Untreated pairs only")
```


### Disease state - All Samples

```{r plot_primet_vs_contrib, fig.width=10, fig.height=20}
#categorical scatter plot - sample-type by contribution
plot.temp <-  plot_data_pri_met_combined %>% 
  filter(`Patient ID`!="E167") %>% 
  group_by(Signature) %>% 
  filter(any(Contribution > 100)) %>%   
  group_by(Signature) %>% mutate(label=ifelse(
    Contribution > (quantile(Contribution)[["75%"]] + (1.5*IQR(Contribution))),
    A5_ID,
    NA))

gg_contrib_by_category(plot.temp , "sample_type", "treatment_state") +
  ggtitle("Specimen type vs contribution - All samples")
```

### Disease state - paired only

```{r plot_primet_vs_contrib_restricted, fig.width=10, fig.height=20}
gg_contrib_by_category(plot.temp %>%  
                         filter(`Patient ID`%in% pri_met_paired) %>% 
                         group_by(Signature) %>% 
                         filter(any(Contribution > 100)) , "sample_type", "treatment_state") + 
  ggtitle("Specimen type vs contribution - Pri/Met pairs only")
```

## {-}

# Comparative context profile plots  

```{r profile_comparison}
########### 
# Profile comparison 
###########

spectrum_comp_plots_primet <- list()
for (Patient in pri_met_paired)
{
  ts <- a5_anno %>% filter(`Patient ID`==Patient) %>%  
    arrange(desc(is_primary_or_met)) %>% 
    mutate(label=paste(A5_ID, PublicationID, sep="/")) %>% 
    filter(A5_ID != "E159-2") #removed unrelated primary from E159
  
  key = stringr::str_extract(string = ts$label, "E...-.")
  spectrum_comp_plots_primet[[paste0(key[[2]],"vs", key[[1]])]] <- 
    MutationalPatterns::plot_compare_profiles(mut_mat[,ts$A5_ID[[2]]], 
                                              mut_mat[,ts$A5_ID[[1]]], 
                                              profile_names = c(ts$label[[2]], ts$label[[1]])) + 
    theme(strip.text.x = element_text(size=8), strip.text.y = element_text(size=8)) 
  
  if(nrow(ts)==3)
  {
    spectrum_comp_plots_primet[[paste0(key[[3]],"vs", key[[1]])]] <-
      MutationalPatterns::plot_compare_profiles(mut_mat[,ts$A5_ID[[3]]], 
                                                mut_mat[,ts$A5_ID[[1]]], 
                                                profile_names = c(ts$label[[3]], ts$label[[1]])) + 
      theme(strip.text.x = element_text(size=8), strip.text.y = element_text(size=8)) 
  }
  
}

spectrum_comp_plots_treatment <- list()
for (Patient in paired_treated_untreated)
{
  ts <- treatment_state %>% filter(`Patient ID`==Patient) %>%  
    arrange(treatment_state) %>% 
    mutate(label=paste(PublicationID,treatment_state)) 
  
  key = stringr::str_extract(string = ts$label, "E...-..")
  spectrum_comp_plots_treatment[[paste0(key[[1]],"vs", key[[2]])]] <- 
    MutationalPatterns::plot_compare_profiles(mut_mat[,ts$A5_ID[[1]]], 
                                              mut_mat[,ts$A5_ID[[2]]], 
                                              profile_names = c(ts$label[[1]], ts$label[[2]])) + 
    theme(strip.text.x = element_text(size=8), strip.text.y = element_text(size=8)) 
  
  if(nrow(ts)==3)
  {
    spectrum_comp_plots_treatment[[paste0(key[[1]],"vs", key[[3]])]] <-
      MutationalPatterns::plot_compare_profiles(mut_mat[,ts$A5_ID[[1]]], 
                                                mut_mat[,ts$A5_ID[[3]]], 
                                                profile_names = c(ts$label[[1]], ts$label[[3]])) + 
      theme(strip.text.x = element_text(size=8), strip.text.y = element_text(size=8)) 
    
    spectrum_comp_plots_treatment[[paste0(key[[2]],"vs", key[[3]])]] <-
      MutationalPatterns::plot_compare_profiles(mut_mat[,ts$A5_ID[[2]]], 
                                                mut_mat[,ts$A5_ID[[3]]], 
                                                profile_names = c(ts$label[[2]], ts$label[[3]])) + 
      theme(strip.text.x = element_text(size=8), strip.text.y = element_text(size=8)) 
  }
}
```

## Treated/untreated {.tabset}

### E132 

```{r}
spectrum_comp_plots_treatment$`E132-R1vsE132-M1`
```

### E143 

E143-2/E143-M2 (Treated) vs E143-3/E143-P1 Untreated

```{r}
spectrum_comp_plots_treatment$`E143-M2vsE143-P1`

```

E143-2/E143-M2 (Treated) vs E143-1/E143-M1 Untreated

```{r}
spectrum_comp_plots_treatment$`E143-M2vsE143-M1`
```

### E167 

```{r}
spectrum_comp_plots_treatment$`E167-M2vsE167-M1`
```

### E169 

```{r}
spectrum_comp_plots_treatment$`E169-M2vsE169-M1`
```

## {-}

## Primary/metastasis pairs {.tabset}

### E146 

```{r}
spectrum_comp_plots_primet$`E146-2vsE146-1`
```

### E158

```{r}
spectrum_comp_plots_primet$`E158-2vsE158-1`
```

### E159

E159-M1(E159-1) vs E159-P1(E159-3)

```{r}
spectrum_comp_plots_primet$`E159-1vsE159-3`
```

E159-M2(E159-4) vs E159-P1(E159-3)

```{r}
spectrum_comp_plots_primet$`E159-4vsE159-3`
```

### E225

```{r}
spectrum_comp_plots_primet$`E225-2vsE225-1`
```

## {-}

